{
  "id": "0001",
  "title": "App DB schema initializer (all SPEC tables)",
  "epic": "Epic 1. Data Layer",
  "task": {
    "description": "Add an app-specific schema initializer that creates all SPEC tables, constraints, triggers, and indexes, and wire it into the existing DB init so it runs on startup without touching template auth tables.",
    "acceptance_criteria": [
      "On server start, running `SELECT name FROM sqlite_master WHERE type='table'` includes: categories, monetization_tips, learning_samples, style_profiles, posts, photos, crawl_sources, crawl_summaries, post_versions, plagiarism_checks, seo_analyses.",
      "Unique constraints exist and are enforced: categories(userId,name), monetization_tips(userId,categoryId), style_profiles(userId,categoryId), crawl_summaries(userId,postId), post_versions(postId,versionNumber), photos(postId,sortOrder).",
      "CHECK constraints reject invalid enums: posts.status not in ('draft','generated','exported') fails insert; crawl_sources.provider not in ('naver','kakao','google','blog') fails insert; learning_samples.sourceType not in ('url','file') fails insert.",
      "A DB trigger prevents inserting a 21st photo for the same postId by raising an abort; inserts 1â€“20 succeed, insert 21 fails.",
      "`next build` completes successfully with the schema wired into `src/lib/db.ts`."
    ]
  },
  "covers": [
    "F1-AC1",
    "F2-AC1",
    "F3-AC1",
    "F4-AC1",
    "F5-AC1",
    "F6-AC1",
    "F7-AC1",
    "F8-AC1"
  ],
  "files": [
    "src/lib/db/appSchema.ts",
    "src/lib/db.ts"
  ],
  "definition_of_done": [
    "All CREATE TABLE/INDEX/TRIGGER statements are idempotent (IF NOT EXISTS) and run without errors on a fresh DB.",
    "Foreign keys are enabled and all specified ON DELETE CASCADE relations are present.",
    "Build passes with TypeScript strict and no lint/type errors."
  ],
  "depends_on": [],
  "db_schema": "-- SQLite schema (executed via appSchema.ts)\nPRAGMA foreign_keys = ON;\n\nCREATE TABLE IF NOT EXISTS categories (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  name TEXT NOT NULL,\n  description TEXT NULL,\n  createdAt INTEGER NOT NULL,\n  updatedAt INTEGER NOT NULL,\n  CONSTRAINT categories_name_len CHECK (length(name) BETWEEN 1 AND 50)\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_categories_user_name ON categories(userId, name);\nCREATE INDEX IF NOT EXISTS idx_categories_user_updated ON categories(userId, updatedAt DESC);\n\nCREATE TABLE IF NOT EXISTS monetization_tips (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  categoryId TEXT NOT NULL REFERENCES categories(id) ON DELETE CASCADE,\n  recommendedMethod TEXT NOT NULL,\n  tipText TEXT NOT NULL,\n  createdAt INTEGER NOT NULL,\n  updatedAt INTEGER NOT NULL,\n  CONSTRAINT monetization_recommended_len CHECK (length(recommendedMethod) BETWEEN 1 AND 60),\n  CONSTRAINT monetization_tip_len CHECK (length(tipText) BETWEEN 1 AND 500)\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_monetization_user_category ON monetization_tips(userId, categoryId);\n\nCREATE TABLE IF NOT EXISTS learning_samples (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  categoryId TEXT NOT NULL REFERENCES categories(id) ON DELETE CASCADE,\n  sourceType TEXT NOT NULL CHECK (sourceType IN ('url','file')),\n  sourceUrl TEXT NULL,\n  fileName TEXT NULL,\n  rawText TEXT NOT NULL,\n  createdAt INTEGER NOT NULL,\n  CONSTRAINT learning_raw_len CHECK (length(rawText) BETWEEN 200 AND 200000),\n  CONSTRAINT learning_source_rules CHECK (\n    (sourceType='url' AND sourceUrl IS NOT NULL AND fileName IS NULL) OR\n    (sourceType='file' AND fileName IS NOT NULL AND sourceUrl IS NULL)\n  )\n);\nCREATE INDEX IF NOT EXISTS idx_learning_user_category_created ON learning_samples(userId, categoryId, createdAt DESC);\n\nCREATE TABLE IF NOT EXISTS style_profiles (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  categoryId TEXT NOT NULL REFERENCES categories(id) ON DELETE CASCADE,\n  profileJson TEXT NOT NULL,\n  sampleCount INTEGER NOT NULL CHECK (sampleCount >= 0),\n  createdAt INTEGER NOT NULL,\n  updatedAt INTEGER NOT NULL\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_style_profiles_user_category ON style_profiles(userId, categoryId);\n\nCREATE TABLE IF NOT EXISTS posts (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  categoryId TEXT NOT NULL REFERENCES categories(id),\n  locationName TEXT NOT NULL,\n  overallNote TEXT NOT NULL,\n  title TEXT NOT NULL DEFAULT '',\n  contentMarkdown TEXT NOT NULL DEFAULT '',\n  status TEXT NOT NULL CHECK (status IN ('draft','generated','exported')),\n  createdAt INTEGER NOT NULL,\n  updatedAt INTEGER NOT NULL,\n  CONSTRAINT posts_location_len CHECK (length(locationName) BETWEEN 1 AND 80),\n  CONSTRAINT posts_overall_len CHECK (length(overallNote) BETWEEN 1 AND 5000)\n);\nCREATE INDEX IF NOT EXISTS idx_posts_user_updated ON posts(userId, updatedAt DESC);\nCREATE INDEX IF NOT EXISTS idx_posts_user_category ON posts(userId, categoryId);\n\nCREATE TABLE IF NOT EXISTS photos (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  originalFileName TEXT NOT NULL,\n  storedFilePath TEXT NOT NULL,\n  memo TEXT NOT NULL,\n  sortOrder INTEGER NOT NULL,\n  createdAt INTEGER NOT NULL,\n  CONSTRAINT photos_memo_len CHECK (length(memo) BETWEEN 1 AND 500),\n  CONSTRAINT photos_sort_positive CHECK (sortOrder >= 1)\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_photos_post_sort ON photos(postId, sortOrder);\nCREATE INDEX IF NOT EXISTS idx_photos_post_created ON photos(postId, createdAt ASC);\n\nCREATE TRIGGER IF NOT EXISTS trg_photos_max_20\nBEFORE INSERT ON photos\nFOR EACH ROW\nWHEN (SELECT COUNT(1) FROM photos WHERE postId = NEW.postId) >= 20\nBEGIN\n  SELECT RAISE(ABORT, 'max_photos_per_post_exceeded');\nEND;\n\nCREATE TABLE IF NOT EXISTS crawl_sources (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  provider TEXT NOT NULL CHECK (provider IN ('naver','kakao','google','blog')),\n  sourceUrl TEXT NULL,\n  snippetText TEXT NOT NULL,\n  rating REAL NULL,\n  createdAt INTEGER NOT NULL,\n  CONSTRAINT crawl_snippet_len CHECK (length(snippetText) BETWEEN 20 AND 2000),\n  CONSTRAINT crawl_rating_range CHECK (rating IS NULL OR (rating >= 0 AND rating <= 5))\n);\nCREATE INDEX IF NOT EXISTS idx_crawl_sources_post_created ON crawl_sources(userId, postId, createdAt ASC);\n\nCREATE TABLE IF NOT EXISTS crawl_summaries (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  totalCount INTEGER NOT NULL CHECK (totalCount BETWEEN 0 AND 17),\n  averageRating REAL NULL,\n  summaryText TEXT NOT NULL,\n  createdAt INTEGER NOT NULL\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_crawl_summaries_user_post ON crawl_summaries(userId, postId);\n\nCREATE TABLE IF NOT EXISTS post_versions (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  versionNumber INTEGER NOT NULL CHECK (versionNumber >= 1),\n  promptNote TEXT NOT NULL DEFAULT '',\n  title TEXT NOT NULL,\n  contentMarkdown TEXT NOT NULL,\n  createdAt INTEGER NOT NULL,\n  CONSTRAINT post_versions_title_len CHECK (length(title) BETWEEN 1 AND 120),\n  CONSTRAINT post_versions_content_len CHECK (length(contentMarkdown) BETWEEN 200 AND 200000)\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_post_versions_post_version ON post_versions(postId, versionNumber);\nCREATE INDEX IF NOT EXISTS idx_post_versions_post_created ON post_versions(userId, postId, createdAt DESC);\n\nCREATE TABLE IF NOT EXISTS plagiarism_checks (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  versionId TEXT NOT NULL REFERENCES post_versions(id),\n  similarityScore INTEGER NOT NULL CHECK (similarityScore BETWEEN 0 AND 100),\n  comparedSourceIds TEXT NOT NULL,\n  passed INTEGER NOT NULL CHECK (passed IN (0,1)),\n  createdAt INTEGER NOT NULL\n);\nCREATE INDEX IF NOT EXISTS idx_plagiarism_post_version ON plagiarism_checks(userId, postId, versionId, createdAt DESC);\n\nCREATE TABLE IF NOT EXISTS seo_analyses (\n  id TEXT PRIMARY KEY,\n  userId TEXT NOT NULL REFERENCES users(id),\n  postId TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,\n  versionId TEXT NOT NULL REFERENCES post_versions(id),\n  keywordDensityScore INTEGER NOT NULL CHECK (keywordDensityScore BETWEEN 0 AND 100),\n  titleOptimizationScore INTEGER NOT NULL CHECK (titleOptimizationScore BETWEEN 0 AND 100),\n  metaDescriptionScore INTEGER NOT NULL CHECK (metaDescriptionScore BETWEEN 0 AND 100),\n  readabilityScore INTEGER NOT NULL CHECK (readabilityScore BETWEEN 0 AND 100),\n  internalLinksScore INTEGER NOT NULL CHECK (internalLinksScore BETWEEN 0 AND 100),\n  overallScore INTEGER NOT NULL CHECK (overallScore BETWEEN 0 AND 100),\n  suggestions TEXT NOT NULL,\n  createdAt INTEGER NOT NULL\n);\nCREATE INDEX IF NOT EXISTS idx_seo_post_version ON seo_analyses(userId, postId, versionId, createdAt DESC);\n",
  "api_contract": "",
  "dependencies": [],
  "ui_requirements": ""
}